<div class="execution-tab">
    <h2>ğŸš€ ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ</h2>

    <!-- ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ -->
    <div class="card" style="background: #d1ecf1; border-left: 4px solid #17a2b8; color: #0c5460;">
        <p style="margin: 0;">ğŸ’¡ <strong>ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:</strong> è¤‡æ•°ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚¿ã‚¹ã‚¯ã«å–ã‚Šçµ„ã¿ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç«¶ã„åˆã„ã¾ã™ã€‚</p>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="card">
        <h3>æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ</h3>
        <form class="task-form"
              hx-post="/execute"
              hx-target="#results"
              hx-swap="innerHTML"
              hx-on="htmx:xhr:loadstart: htmx.addClass('#status-display', 'htmx-settling')"
              hx-on="htmx:xhr:loadstart: htmx.removeClass('#status-display', 'hidden')">

            <input type="text"
                   name="task"
                   placeholder="ä¾‹: 17ãŒç´ æ•°ã‹ã©ã†ã‹åˆ¤å®šã—ã¦ãã ã•ã„"
                   required
                   maxlength="10000"
                   autocomplete="off">

            <button type="submit">
                å®Ÿè¡Œé–‹å§‹ ğŸš€
                <span class="htmx-indicator loading"></span>
            </button>
        </form>
    </div>

    <!-- å®Ÿè¡ŒçŠ¶æ…‹è¡¨ç¤º -->
    <div id="status-display" class="card hidden" style="display: none;">
        <h3>å®Ÿè¡Œä¸­...</h3>
        <div style="text-align: center; padding: 2rem;">
            <div class="loading" style="margin: 1rem auto; width: 40px; height: 40px; border-width: 4px;"></div>
            <p style="color: #666; margin-top: 1rem;">è¤‡æ•°ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚¿ã‚¹ã‚¯ã«å–ã‚Šçµ„ã‚“ã§ã„ã¾ã™...</p>
        </div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="error-display" class="card hidden" style="display: none;">
        <!-- htmxã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
    </div>

    <!-- çµæœè¡¨ç¤º -->
    <div id="results" class="card" style="display: none;">
        <h3>ğŸ“Š è©•ä¾¡çµæœ</h3>
        <div id="results-content"></div>
    </div>
</div>

<script>
    // é–¢é€£ã™ã‚‹ã®DOMè¦ç´ ã‚’å–å¾—
    const statusDisplay = document.getElementById('status-display');
    const resultsDiv = document.getElementById('results');
    const errorDisplay = document.getElementById('error-display');
    const taskForm = document.querySelector('.task-form');

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
    taskForm.addEventListener('htmx:beforeRequest', function(evt) {
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤ºã€çµæœã‚’éè¡¨ç¤º
        statusDisplay.style.display = 'block';
        statusDisplay.classList.remove('hidden');
        resultsDiv.style.display = 'none';
        errorDisplay.style.display = 'none';
        errorDisplay.innerHTML = '';
    });

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†æ™‚ã®å‡¦ç†
    document.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'results') {
            statusDisplay.style.display = 'none';
            statusDisplay.classList.add('hidden');
            resultsDiv.style.display = 'block';
            window.scrollTo(0, resultsDiv.offsetTop - 100);
        }
    });

    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    document.addEventListener('htmx:responseError', function(evt) {
        statusDisplay.style.display = 'none';
        statusDisplay.classList.add('hidden');
        errorDisplay.style.display = 'block';

        const status = evt.detail.xhr.status;
        const response = evt.detail.xhr.response;

        let errorHtml = `
            <div class="alert alert-error">
                <strong>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (HTTP ${status})</strong>
                <p>${response || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'}</p>
            </div>
        `;

        errorDisplay.innerHTML = errorHtml;
    });

    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    document.addEventListener('htmx:timeout', function(evt) {
        statusDisplay.style.display = 'none';
        statusDisplay.classList.add('hidden');
        errorDisplay.style.display = 'block';

        let errorHtml = `
            <div class="alert alert-error">
                <strong>ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ</strong>
                <p>å®Ÿè¡Œæ™‚é–“ãŒé•·ã™ãã¾ã™ã€‚åˆ¥ã®ã‚¿ã‚¹ã‚¯ã‚’è©¦ã™ã‹ã€ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>
            </div>
        `;

        errorDisplay.innerHTML = errorHtml;
    });
</script>
